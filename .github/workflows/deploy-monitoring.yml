name: Deploy Monitoring Stack

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ai-image-classifier

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Create kind cluster
      uses: helm/kind-action@v1
      with:
        cluster_name: kind
        version: v0.20.0
        wait: 120s

    - name: Delete Helm release secrets
      run: |
        echo "=== DELETING HELM SECRETS ==="
        kubectl delete secret -n monitoring-cicd -l name=prometheus 2>/dev/null || true
        kubectl delete secret -n monitoring-cicd -l owner=helm 2>/dev/null || true
        kubectl delete secret -n monitoring-cicd -l status=failed 2>/dev/null || true
        echo "=== HELM SECRETS DELETED ==="

    - name: Nuclear cleanup before install
      run: |
        echo "=== STARTING CLEANUP ==="
        kubectl delete namespace monitoring-cicd --force --grace-period=0 2>/dev/null || echo "Namespace not found"
        
        # Delete ClusterRoles and bindings
        kubectl delete clusterrole -l app.kubernetes.io/instance=prometheus 2>/dev/null || true
        kubectl delete clusterrolebinding -l app.kubernetes.io/instance=prometheus 2>/dev/null || true
        echo "=== CLEANUP COMPLETE ==="

    - name: Install Helm
      uses: azure/setup-helm@v3

    - name: Add Prometheus Helm repository
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update

    - name: Create monitoring namespace
      run: |
        kubectl create namespace monitoring-cicd

    - name: Install Prometheus Stack
      run: |
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
          --namespace monitoring-cicd \
          --set grafana.adminPassword=prom-operator \
          --wait \
          --timeout 10m

    ### ðŸ”´ THIS IS THE RIGHT PLACE FOR DEBUGGING ###
    - name: ðŸ”´ DEBUG - Cluster is LIVE! Inspect now
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
    ### Workflow will PAUSE here for you to explore ###

    - name: Verify Installation
      run: |
        echo "=== Checking Pods ==="
        kubectl get pods -n monitoring-cicd

        echo -e "\n=== Checking Services ==="
        kubectl get svc -n monitoring-cicd

    - name: Get Grafana admin password
      run: |
        PASSWORD=$(kubectl get secret -n monitoring-cicd prometheus-grafana \
          -o jsonpath="{.data.admin-password}" | base64 --decode)
        echo "Grafana admin password: $PASSWORD"

    - name: Deploy ServiceMonitor
      run: |
        if [ -f "k8s/service-monitor.yaml" ]; then
          # Update namespace in ServiceMonitor if needed
          sed -i 's/namespace: monitoring/namespace: monitoring-cicd/g' k8s/service-monitor.yaml
          kubectl apply -f k8s/service-monitor.yaml
          echo "ServiceMonitor applied"
        fi

    - name: Export monitoring endpoints
      run: |
        echo "=== Monitoring Access Information ==="
        echo "Grafana: kubectl port-forward -n monitoring-cicd service/prometheus-grafana 3000:80"
        echo "Prometheus: kubectl port-forward -n monitoring-cicd service/prometheus-kube-prometheus-prometheus 9090:9090"
